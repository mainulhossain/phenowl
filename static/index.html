<!DOCTYPE html>
<html>
<head>
<title>PhenoWL Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
<!-- <script src="http://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> -->
<script src="ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="ace-builds/src-min-noconflict/ext-language_tools.js"></script>
<style>

.odd-row {
background-color: LightGray;
}
.even-row {
background-color: White;
}

</style>
</head>
<body>
    <div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">PhenoWL</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#">Home</a></li>
            </ul>
        </div>
    </div>
</div>
    <div class="container">
        <div id="main" class="row">
            <div class="col-md-6">
                <div class="panel panel-default">
                    <h2>Phenotype Workflow Language</h2>
                    <span>Write script to create a pipeline.</span><br>
                    <span>Drag functions from the right.</span>
                </div>
		        
		        <textarea rows="20" style="min-width: 100%" id="script"></textarea><br>
		        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: runPhenoWL">Run</button>
		        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: clearEditor">Clear</button>
		        <span class="glyphicon glyphicon-repeat normal-right-spinner pull-right" id="refresh"></span>
		        <br><br>
		        <label>Output:</label>
		        <textarea rows="10" style="min-width: 100%" id="output"></textarea><br>
		        <label>Error:</label>
		        <textarea rows="5" style="min-width: 100%" id="error"></textarea>
            </div>
            <div class="col-sm-4" id="functions">
	            <div   class="panel panel-default">
	                <div class="panel-heading">
	                   <div class="row">
	                       <div class="col-sm-4"><h5 class="">Functions</h5></div>
	                       <div class="col-sm-4"><h5 class="">Package</h5></div>
	                   </div>
	                </div>
	                <div class="panel-body draggable-functions">
	                        <!-- ko foreach: tasks -->
	                        <div class="row" data-bind="attr: { title: desc }, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
	                           <div class="col-sm-4 draggable-func" data-bind="text: name"></div>
	                           <div class="col-sm-4" data-bind="text: package_name"></div>
	                        </div>
	                        <!-- /ko -->
	                </div>
	            </div>
                    <div class="panel panel-default">
                    <div class="panel-heading">
                       <div class="row">
                           <div class="col-sm-4"><h5 class="">Samples</h5></div>
                       </div>
                    </div>
                    <div class="panel-body draggable-samples">
                            <!-- ko foreach: samples -->
                            <div class="row" data-bind="attr: { title: desc }, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
                               <div class="draggable-sample" data-bind="text: name"></div>
                            </div>
                            <!-- /ko -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="addDialogLabel">Add Task</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputTask">Task</label>
                    <div class="controls">
                        <input data-bind="value: module" type="text" id="inputTask" placeholder="Module" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inpunamen">name</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="inputDescription" placeholder="Name" style="width: 300px;">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: addTask" class="btn btn-primary">Add Task</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>
    <div id="edit" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="editDialogLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="editDialogLabel">Edit Task</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputTask">Task</label>
                    <div class="controls">
                        <input data-bind="value: module" type="text" id="inputTask" placeholder="Module" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputDescription">Name</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="inputDescription" placeholder="Name" style="width: 300px;">
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox"> Done
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click:editTask" class="btn btn-primary">Update Task</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>
    <div id="login" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
        <div class="modal-header">
            <h3 id="loginLabel">Sign In</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputUsername">Username</label>
                    <div class="controls">
                        <input data-bind="value: username" type="text" id="inputUsername" placeholder="Username">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input data-bind="value: password" type="password" id="inputPassword" placeholder="Password">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: login" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Sign In</button>
        </div>
    </div>
    <script type="text/javascript">
    

    $(window).on('load', function() {
    	    	
    	$('#refresh').hide();
    	   	 
        $('.draggable-functions').each(function() {
             // inner scope
             var phrase = $(this);
             
             $(this).find('div.draggable-func').each(function() {
                 // cache jquery object
                 var current = $(this);
//                 current.addClass("draggable-func");
                 current.draggable({
                     revert : 'invalid',
                     stack : '.draggable-func',
                     helper : 'clone'
                 });
//                  current.on("dragstart", function(e) {
//                 	 e.originalEvent.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
//                  current.bind('dragstart', function(e) {
//                         e.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
             });
         });
        
        $('.draggable-samples').each(function() {
            // inner scope
            var phrase = $(this);
            
            $(this).find('div.draggable-sample').each(function() {
                // cache jquery object
                var current = $(this);
                current.draggable({
                    revert : 'invalid',
                    stack : '.draggable-sample',
                    helper : 'clone'
                });
            });
        });
                 
    });
       
    // configure ace.js for code editor
    var textarea = $("#script");
    
    var editDiv = $('<div>', {
        position: 'absolute',
        id: 'aceeditor',
        width: textarea.width(),
        height: textarea.height(),
        'class': textarea.attr('class'),
        'css': 'border:2px solid black'
    }).insertBefore(textarea);
        
    textarea.css('visibility', 'hidden');
    var offset = editDiv.offset();
    textarea.attr('rows', 1);
    
    var editor = ace.edit(editDiv[0]);
    editor.renderer.setShowGutter(false);
    editor.getSession().setValue(textarea.val());
    editor.getSession().setMode("ace/mode/python");
    editor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
    editor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
    //editor.setKeyboardHandler("ace/keyboard/vim");
    //editor.setTheme("ace/theme/idle_fingers");
    //editor.setTheme("ace/theme/twilight");
    editor.setTheme("ace/theme/iplastic");
//     editor.setOptions({       
//         fontSize: "12pt"
//       });
    
    $("#aceeditor").droppable({

        activeClass: "ui-state-default",
        hoverClass: "ui-state-hover",
        accept: ":not(.ui-sortable-helper)",

        drop: function(event, ui) {
          var pos = editor.renderer.screenToTextCoordinates(event.clientX, event.clientY)
          var v = ko.dataFor(ui.draggable[0]);
          example = ''
          if (v)
        	  if (v.example)
        		  example = v.example();
        	  else if (v.sample)
        		  example = v.sample();
              else
            	  example = v.name() + "()";
          
          editor.session.insert(pos, example);
          editor.focus();
          return true;
        }
      });

    
        function TasksViewModel() {
            var self = this;
            self.tasksURI = 'todo/api/v1.0/tasks';
            self.username = "";
            self.password = "";
            self.tasks = ko.observableArray();
            self.samplesURI = 'todo/api/v1.0/samples';
            self.samples = ko.observableArray();
            
            self.clearEditor = function() {
                editor.session.setValue("");
                $("#output").val("");
                $("#error").val("");
            }

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa(self.username + ":" + self.password));
                    },
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }
            self.updateTask = function(task, newTask) {
                var i = self.tasks.indexOf(task);
                self.tasks()[i].package_name(newTask.package_name);
                self.tasks()[i].name(newTask.name);
                self.tasks()[i].internal(newTask.internal);
                self.tasks()[i].example(newTask.example);
                self.tasks()[i].desc(newTask.desc);
            }

            self.beginAdd = function() {
                $('#add').modal('show');
            }
            self.runPhenoWL = function(task) {
            	$('#refresh').show();
                self.ajax(self.tasksURI, 'POST', {'script': editor.getSession().getValue()}).done(function(data) {
                	$('#refresh').hide();
                	
                	text = '';
                    $.each(data.out, function(i, t) {
                    	text += t + '\n';
                    });
                	$("#output").val(text);
                    
                	text = '';
                    $.each(data.err, function(i, t) {
                        text += t + '\n';
                    });
                    
                    $("#error").val(text);
                });
            }
            self.beginEdit = function(task) {
                editTaskViewModel.setTask(task);
                $('#edit').modal('show');
            }
            self.edit = function(task, data) {
                self.ajax(task.uri(), 'PUT', data).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.remove = function(task) {
                self.ajax(task.uri(), 'DELETE').done(function() {
                    self.tasks.remove(task);
                });
            }
            self.markInProgress = function(task) {
                self.ajax(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.markDone = function(task) {
                self.ajax(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.beginLogin = function() {
                $('#login').modal('show');
            }
            self.login = function(username, password) {
                self.username = username;
                self.password = password;
                self.ajax(self.tasksURI, 'GET').done(function(data) {
                    for (var i = 0; i < data.tasks.length; i++) {
                        self.tasks.push({
                            package_name: ko.observable(data.tasks[i].package_name),
                            name: ko.observable(data.tasks[i].name),
                            internal: ko.observable(data.tasks[i].internal),
                            example: ko.observable(data.tasks[i].example),
                            desc: ko.observable(data.tasks[i].desc)
                        });
                    }
                }).fail(function(jqXHR) {
                    if (jqXHR.status == 403)
                        setTimeout(self.beginLogin, 500);
                });
            }
            self.loadSamples = function(username, password) {
                self.username = username;
                self.password = password;
                self.ajax(self.samplesURI, 'GET').done(function(data) {
                    for (var i = 0; i < data.samples.length; i++) {
                        self.samples.push({
                            name: ko.observable(data.samples[i].name),
                            sample: ko.observable(data.samples[i].sample),
                            desc: ko.observable(data.samples[i].desc)
                        });
                    }
                }).fail(function(jqXHR) {
                    if (jqXHR.status == 403)
                        setTimeout(self.beginLogin, 500);
                });
            }
            //self.beginLogin();
        }
        
        function SamplesViewModel() {
            var self = this;
            self.samplesURI = 'todo/api/v1.0/samples';
            self.username = "";
            self.password = "";
            self.samples = ko.observableArray();

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa(self.username + ":" + self.password));
                    },
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }
            
            self.loadSamples = function(username, password) {
                self.username = username;
                self.password = password;
                self.ajax(self.samplesURI, 'GET').done(function(data) {
                    for (var i = 0; i < data.samples.length; i++) {
                        self.samples.push({
                            name: ko.observable(data.samples[i].name),
                            sample: ko.observable(data.samples[i].sample),
                            desc: ko.observable(data.samples[i].desc)
                        });
                    }
                }).fail(function(jqXHR) {
                    if (jqXHR.status == 403)
                        setTimeout(self.beginLogin, 500);
                });
            }
        }
        
        function AddTaskViewModel() {
            var self = this;
            self.package_name = ko.observable();
            self.name = ko.observable();
 
            self.addTask = function() {
                $('#add').modal('hide');
                tasksViewModel.add({
                    package_name: self.package_name(),
                    name: self.name()
                });
                self.package_name("");
                self.name("");
            }
        }
        function EditTaskViewModel() {
            var self = this;
            self.package_name = ko.observable();
            self.name = ko.observable();
            self.internal = ko.observable();
            self.example = ko.observable();
 
            self.setTask = function(task) {
                self.task = task;
                self.package_name(task.package_name());
                self.name(task.name());
                self.internal(task.internal());
                self.example(task.example());
                $('edit').modal('show');
            }
 
            self.editTask = function() {
                $('#edit').modal('hide');
                tasksViewModel.edit(self.task, {
                	package_name: self.package_name(),
                	name: self.name(),
                    internal: self.internal(),
                    example: self.example()
                });
            }
        }
        function LoginViewModel() {
            var self = this;
            self.username = ko.observable();
            self.password = ko.observable();
            tasksViewModel.login('mainulhossain@gmail.com', 'mainul');
            tasksViewModel.loadSamples('mainulhossain@gmail.com', 'mainul')
            
            self.login = function() {
                $('#login').modal('hide');
                tasksViewModel.login(self.username(), self.password());
            }
        }
        
        var tasksViewModel = new TasksViewModel();
        var addTaskViewModel = new AddTaskViewModel();
        var editTaskViewModel = new EditTaskViewModel();
        var loginViewModel = new LoginViewModel();
//        var samplesViewModel = new SamplesViewModel();
//        samplesViewModel.loadSamples('mainulhossain@gmail.com', 'mainul')
        ko.applyBindings(tasksViewModel, $('#main')[0]);
//         ko.applyBindings(addTaskViewModel, $('#add')[0]);
//         ko.applyBindings(editTaskViewModel, $('#edit')[0]);
        ko.applyBindings(loginViewModel, $('#login')[0]);
//        ko.applyBindings(samplesViewModel, $('#samples')[0]);
    </script>
</body>
</html>
