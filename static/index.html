<!DOCTYPE html>
<html>
<head>
<title>BioWL Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css">

<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
<!-- <script src="http://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> -->
<script src="ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="ace-builds/src-min-noconflict/ext-language_tools.js"></script>
<script src="https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js"></script>
<style>

.odd-row {
background-color: LightGray;
}
.even-row {
background-color: White;
}

</style>
</head>
<body>
    <div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">BioWL</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#">Home</a></li>
            </ul>
        </div>
    </div>
</div>
    <div class="container">
        <div></div>
        <div id="main" class="row">
            <div class="col-md-6" style="padding:2px">
                <div class="panel panel-primary">
                    <div class="panel-heading">
	                    <h2>Bioinformatics Workflow Language</h2>
	                    <span class="bg-info text-info">Write script to create a pipeline.</span><br>
	                    <span class="bg-info text-info">Drag functions/samples from the right.</span>
                    </div>
                    <div class="panel-body" style="padding=0; margin=0px;">
        		        <textarea rows="16" style="width: 100%; height=100%; padding=0; margin=0px;" id="script"></textarea><br>
		            </div>
		        </div>
		        <div class="panel panel-primary" style="padding:2px">
			        <div class="panel-body" style="padding:0">
				        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: runBioWL">Run</button>
				        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: clearEditor">Clear</button>
				        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: beginAddLibrary">Add Library</button>
				        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: beginAddSample">Save</button>
				        <button class="btn pull-left" style="margin-right: 5px;" data-bind="click: generatePythonCode">Python Code</button>
				        <div>Time: <span id="duration"></span></div>
			            <span class="glyphicon glyphicon-repeat normal-right-spinner pull-right" id="refresh"></span>
			        </div>
		        </div>
		        <div class="panel panel-success" style="padding:2px">
			         <div class="panel-heading">
			          <label>Output:</label>
			         </div>
			         <div class="panel-body" style="padding:0">
			          <textarea rows="5" style="min-width: 100%" id="output"></textarea><br>
			        </div>
		        </div>
		       <div class="panel panel-danger" style="padding:2px">
                <div class="panel-heading">
                  <label>Error:</label>
                 </div>
                 <div class="panel-body" style="padding:0">
		        <textarea rows="3" style="min-width: 100%" id="error"></textarea>
		        </div>
		        </div>
            </div>
            <div class="col-sm-4" id="functions" style="padding:2px">
	            <div   class="panel panel-primary">
	                <div class="panel-heading ">
	                   <div class="row">
	                       <div class="col-sm-4"><h5 class="">Functions</h5></div>
	                       <div class="col-sm-4"><h5 class="">Package</h5></div>
	                   </div>
	                </div>
	                <div class="panel-body draggable-functions" style="max-height: 500px; overflow-y: scroll; padding:3px">
	                        <!-- ko foreach: tasks -->
	                        <div class="row" data-bind="attr: { title: desc }, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
	                           <div class="col-sm-4 draggable-func" data-bind="text: name"></div>
	                           <div class="col-sm-4" data-bind="text: package_name" style="text-align:right"></div>
	                           <div class="col-sm-4" data-bind="text: runmode" style="text-align:right"></div>
	                        </div>
	                        <!-- /ko -->
	                </div>
	            </div>
                    <div class="panel panel-primary" style="padding:2px">
	                    <div class="panel-heading">
	                       <div class="row">
	                           <div class="col-sm-4"><h5 class="">Workflows</h5></div>
	                       </div>
	                    </div>
	                    <div class="panel-body draggable-samples" style="max-height: 200px; overflow-y: scroll;">
	                            <!-- ko foreach: samples -->
	                            <div class="row" data-bind="attr: { title: desc }, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
	                               <div class="draggable-sample" style="margin-left: 10px" data-bind="text: name"></div>
	                            </div>
	                            <!-- /ko -->
	                    </div>
                    </div>
                    <div id="dataSourcesPanel" class="panel panel-primary">
                        <div class="panel-heading">
                           <div class="row">
                               <div class="col-sm-4"><h5 class="">Data Sources</h5></div>
                           </div>
                           <div class="btn-group">
			                    <div class="btn-group-sm">
			                        <button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Reload" data-bind="click: load"><i class="glyphicon glyphicon-refresh"></i></button>
			                        <button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Download" data-bind="click: download"><i class="glyphicon glyphicon-download"></i></button>
			                        <button class="btn btn-primary pull-right" data-toggle="modal" data-placement="top" title="Upload" data-bind="click: beginFileUpload"><i class="glyphicon glyphicon-upload"></i></button>
			                        <button class="btn btn-primary pull-right" data-toggle="modal" data-placement="top" title="Rename" data-target="#rename-filefolder-dialog" ><i class="glyphicon glyphicon-edit"></i></button>
			                        <button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Delete" onclick="remove();"><i class="glyphicon glyphicon-minus"></i></button>
			                        <button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Add" onclick="addFolder();" ><i class="glyphicon glyphicon-plus"></i></button>
			                    </div>
		                    </div>
                        </div>
                        <div class="panel-body draggable-datasources" style="max-height: 200px; overflow-y: scroll; padding:0">
                            <div id="tree" data-bind="treeView: dataSources"></div>
                        </div>
                    </div>
        </div>
    </div>
   </div>

    <div id="add" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true" style="width: 480px; height: 600px; background: #fff">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="addDialogLabel">Add Library</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="package">Package</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="package" placeholder="Package" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="organization">Organization</label>
                    <div class="controls">
                        <input data-bind="value: org" type="text" id="organization" placeholder="Org" style="width: 300px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="module">Module</label>
                    <div class="controls">
                        <input type="file" id="module">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="mapper">Module to JSON mapper:</label>
                    <div class="controls">
                        <textarea rows="12" style="width: 460px;" id="mapper"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: addLibrary" class="btn btn-primary">Add</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>
    <div id="addSample" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addSampleDialogLabel" aria-hidden="true" style="width: 480px; height: 550px; background: #fff">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="addSampleDialogLabel">Add Sample</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="sampleName">Name</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="sampleName" placeholder="Name" style="width: 300px;">
                    </div>
                    <label class="control-label" for="sampleDesc">Description</label>
                    <div class="controls">
                        <input data-bind="value: desc" type="text" id="sampleDesc" placeholder="Description" style="width: 400px;">
                    </div>
                    <label class="control-label" for="sample">Sample:</label>
                    <div class="controls">
                        <textarea rows="12" style="width: 460px;" id="sample"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: addSample" class="btn btn-primary">Add</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>
    
	<div class="modal fade" id="file-upload-dialog" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <!-- Modal Header -->
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal">
	                       <span aria-hidden="true">&times;</span>
	                       <span class="sr-only">Close</span>
	                </button>
	                <h4 class="modal-title" id="uploadModalLabel">
	                    File Upload
	                </h4>
	            </div>
	            
	            <!-- Modal Body -->
	            <div class="modal-body">
	                <form id="upload-file" class="form-horizontal" role="form" method=POST enctype=multipart/form-data>
	                  <div class="form-group">
	                    <div class="col-sm-offset-2 col-sm-10">
	                        <input type="file" name="file" id="upload" multiple>
	                    </div>
	                  </div>
	                  
	                  <div class="form-group">
	                    <div class="col-sm-offset-2 col-sm-10">
	                      <button data-bind="click: upload" type="button" class="btn btn-default" id="upload-file-btn" data-dismiss="modal">Upload</button>
	                    </div>
	                  </div>
	                </form>
	            </div>
	        </div>
	    </div>
	</div>

    <div id="edit" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="editDialogLabel" aria-hidden="true" style="background: #fff">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="editDialogLabel">Edit Task</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputTask">Task</label>
                    <div class="controls">
                        <input data-bind="value: module" type="text" id="inputTask" placeholder="Module" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputDescription">Name</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="inputDescription" placeholder="Name" style="width: 300px;">
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox"> Done
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click:editTask" class="btn btn-primary">Update Task</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>
    <div id="login" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
        <div class="modal-header">
            <h3 id="loginLabel">Sign In</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputUsername">Username</label>
                    <div class="controls">
                        <input data-bind="value: username" type="text" id="inputUsername" placeholder="Username">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input data-bind="value: password" type="password" id="inputPassword" placeholder="Password">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: login" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Sign In</button>
        </div>
    </div>
    <script type="text/javascript">
    

    $(window).on('load', function() {
    	    	
    	$('#refresh').hide();
    	   	 
        $('.draggable-functions').each(function() {
             // inner scope
             var phrase = $(this);
             
             $(this).find('div.draggable-func').each(function() {
                 // cache jquery object
                 var current = $(this);
//                 current.addClass("draggable-func");
                 current.draggable({
                     revert : 'invalid',
                     stack : '.draggable-func',
                     helper : 'clone'
                 });
//                  current.on("dragstart", function(e) {
//                 	 e.originalEvent.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
//                  current.bind('dragstart', function(e) {
//                         e.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
             });
         });
        
        $('.draggable-samples').each(function() {
            // inner scope
            var phrase = $(this);
            
            $(this).find('div.draggable-sample').each(function() {
                // cache jquery object
                var current = $(this);
                current.draggable({
                    revert : 'invalid',
                    stack : '.draggable-sample',
                    helper : 'clone'
                });
            });
        });
        
        centerDialog = function(dlg) {
            var windowHeight = $(window).height();
            var windowWidth = $(window).width();
            var boxHeight = dlg.height();
            var boxWidth = dlg.width();
            dlg.css({'margin-left' : ((windowWidth - boxWidth )/2), 'margin-top' : ((windowHeight - boxHeight )/2)});
        }
    });

    // Create the View Model.
    var DataSourceViewModel = function() {
      var self = this;
      self.dataSourcesURI = 'todo/api/v1.0/datasources';
      self.dataSources = [];
      
      self.ajax = function(uri, method, data) {
          var request = {
                  url: uri,
                  type: method,
                  contentType: false,
                  processData: false,
                  cache: false,
                  data: data,
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader("Authorization", 
                          "Basic " + btoa(self.username + ":" + self.password));
                  },
                  error: function(jqXHR) {
                      console.log("ajax error " + jqXHR.status);
                  }
              };
              return $.ajax(request);
      }
      
      self.refresh = function(path) {

          self.ajax(self.samplesURI, 'POST', {'path': path}).done(function(data) {
              
          });
      }
      
      self.beginFileUpload = function() {
          centerDialog($('#file-upload-dialog'));
          $('#file-upload-dialog').modal('show');
      }
      
      self.load = function(username, password) {
          self.username = username;
          self.password = password;
          self.ajax(self.dataSourcesURI, 'GET').done(function(data) {
              self.dataSources = data.datasources;
              //$('#tree').treeview({data: self.dataSources});
              ko.applyBindings(dataSourceModel, $("#dataSourcesPanel")[0]);
          }).fail(function(jqXHR) {
              if (jqXHR.status == 403)
                  setTimeout(self.beginLogin, 500);
          });
      }
      
      self.upload = function() {

     	  $('#file-upload-dialog').modal('hide');
          
          var files = $("#upload").get(0).files;
          var formdata = new FormData();
          formdata.append('upload', files[0]); //use get('files')[0]
          nodes = $('#tree').treeview('getSelected')
          if (nodes === undefined || nodes.lenght === 0)
        	  return;
          node = nodes[0];
          formdata.append('path', node.path);//you can append it to formdata with a proper parameter name
          

          self.ajax(self.dataSourcesURI, 'POST', formdata).done(function(data) {
        	 var x = 20; 
          });
       }
      
      self.download = function() {
    	  
    	  nodes = $('#tree').treeview('getSelected')
          if (nodes === undefined || nodes.lenght === 0)
              return;
          node = nodes[0];
          $.redirect(self.dataSourcesURI, { 'download': node.path });
      }
    }
   
    ko.bindingHandlers.treeView = {
        init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
            $(element).treeview({data: valueAccessor()}).on('nodeSelected', function(event, data) {
                var x = 10
            });
        },
        update: function(element, valueAccessor, allBindings) {
            var x = 10;
        }
    };

    // Create the View Model and initialise with initial data 
    var dataSourceModel = new DataSourceViewModel();
    dataSourceModel.load('mainulhossain@gmail.com', 'mainul');
    ko.applyBindings(dataSourceModel, $("#dataSourcesPanel")[0]);
    ko.applyBindings(dataSourceModel, $("#file-upload-dialog")[0]);
    

    // configure ace.js for code editor
    var textarea = $("#script");
    
    var editDiv = $('<div>', {
        position: 'absolute',
        id: 'aceeditor',
        width: textarea.width(),
        height: textarea.height(),
        'class': textarea.attr('class'),
        'css': 'border:2px solid black'
    }).insertBefore(textarea);
        
    textarea.css('visibility', 'hidden');
    var offset = editDiv.offset();
    textarea.attr('rows', 1);
    
    var editor = ace.edit(editDiv[0]);
    editor.renderer.setShowGutter(false);
    editor.getSession().setValue(textarea.val());
    editor.getSession().setMode("ace/mode/python");
    editor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
    editor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
    //editor.setKeyboardHandler("ace/keyboard/vim");
    //editor.setTheme("ace/theme/idle_fingers");
    //editor.setTheme("ace/theme/twilight");
    editor.setTheme("ace/theme/iplastic");
//     editor.setOptions({       
//         fontSize: "12pt"
//       });
    
    $("#aceeditor").droppable({

        activeClass: "ui-state-default",
        hoverClass: "ui-state-hover",
        accept: ":not(.ui-sortable-helper)",

        drop: function(event, ui) {
          var pos = editor.renderer.screenToTextCoordinates(event.clientX, event.clientY)
          var v = ko.dataFor(ui.draggable[0]);
          example = ''
          if (v)
        	  if (v.example)
        		  example = v.example();
        	  else if (v.sample)
        		  example = v.sample();
              else
            	  example = v.name() + "()";
          
          editor.session.insert(pos, example);
          editor.focus();
          return true;
        }
      });

    
        function TasksViewModel() {
            var self = this;
            self.tasksURI = 'todo/api/v1.0/tasks';
            self.username = "";
            self.password = "";
            self.tasks = ko.observableArray();
            self.samplesURI = 'todo/api/v1.0/samples';
            self.samples = ko.observableArray();
            
            self.clearEditor = function() {
                editor.session.setValue("");
                $("#output").val("");
                $("#error").val("");
                $("#duration").text("");
            }

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa(self.username + ":" + self.password));
                    },
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }
            self.updateTask = function(task, newTask) {
                var i = self.tasks.indexOf(task);
                self.tasks()[i].package_name(newTask.package_name);
                self.tasks()[i].name(newTask.name);
                self.tasks()[i].internal(newTask.internal);
                self.tasks()[i].example(newTask.example);
                self.tasks()[i].desc(newTask.desc);
                self.tasks()[i].desc(newTask.runmode);
            }
            
            

            self.beginAddLibrary = function() {
            	var obj = { "functions": [{ "name": "", "internal": "", "example": ""} ] };

            	addLibraryViewModel.getCodeEditor().setValue(JSON.stringify(obj, null, 4), 1);
            	centerDialog($('#add'));
                $('#add').modal('show');
            }
            
            self.beginAddSample = function() {
            	script = editor.getSession().getValue();
            	if (script.length > 0)
            	{
            		sampleViewModel.getCodeEditor().setValue(script, 1);
            	}
                centerDialog($('#addSample'));
                $('#addSample').modal('show');
            }
            
            self.runBioWL = function(task) {
            	$('#refresh').show();
                self.ajax(self.tasksURI, 'POST', {'script': editor.getSession().getValue()}).done(function(data) {
                	$('#refresh').hide();
                	
                	text = '';
                    $.each(data.out, function(i, t) {
                    	text += t + '\n';
                    });
                	$("#output").val(text);
                    
                	text = '';
                    $.each(data.err, function(i, t) {
                        text += t + '\n';
                    });
                    
                    $("#error").val(text);
                    $("#duration").text(data.duration);
                });
            }
            self.generatePythonCode = function(task) {
                $('#refresh').show();
                self.ajax(self.tasksURI, 'POST', {'code': editor.getSession().getValue()}).done(function(data) {
                    $('#refresh').hide();

                    $("#output").val(data.out);
                    
                    text = '';
                    $.each(data.err, function(i, t) {
                        text += t + '\n';
                    });
                    
                    $("#error").val(text);
                    $("#duration").text(data.duration);
                });
            }
            self.beginEditLibrary = function(task) {
               // editTaskViewModel.setTask(task);
                $('#edit').modal('show');
            }
            self.edit = function(task, data) {
                self.ajax(task.uri(), 'PUT', data).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.remove = function(task) {
                self.ajax(task.uri(), 'DELETE').done(function() {
                    self.tasks.remove(task);
                });
            }
            self.markInProgress = function(task) {
                self.ajax(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.markDone = function(task) {
                self.ajax(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                    self.updateTask(task, res.task);
                });
            }
            self.beginLogin = function() {
                $('#login').modal('show');
            }
            self.login = function(username, password) {
                self.username = username;
                self.password = password;
                self.ajax(self.tasksURI, 'GET').done(function(data) {
                    for (var i = 0; i < data.tasks.length; i++) {
                        self.tasks.push({
                            package_name: ko.observable(data.tasks[i].package_name),
                            name: ko.observable(data.tasks[i].name),
                            internal: ko.observable(data.tasks[i].internal),
                            example: ko.observable(data.tasks[i].example),
                            desc: ko.observable(data.tasks[i].desc),
                            runmode: ko.observable(data.tasks[i].runmode)
                        });
                    }
                }).fail(function(jqXHR) {
                    if (jqXHR.status == 403)
                        setTimeout(self.beginLogin, 500);
                });
            }
            self.loadSamples = function(username, password) {
                self.username = username;
                self.password = password;
                self.ajax(self.samplesURI, 'GET').done(function(data) {
                    for (var i = 0; i < data.samples.length; i++) {
                        self.samples.push({
                            name: ko.observable(data.samples[i].name),
                            sample: ko.observable(data.samples[i].sample),
                            desc: ko.observable(data.samples[i].desc)
                        });
                    }
                }).fail(function(jqXHR) {
                    if (jqXHR.status == 403)
                        setTimeout(self.beginLogin, 500);
                });
            }
            //self.beginLogin();
        }
        
        function SampleViewModel() {
            var self = this;
            self.samplesURI = 'todo/api/v1.0/samples';
            
            self.name = ko.observable();
            self.desc = ko.observable();
 
            // configure ace.js for code editor
            var mapperArea = $("#sample");
            
            var mapperDiv = $('<div>', {
                position: 'absolute',
                id: 'aceeditor',
                width: mapperArea.width(),
                height: 200,//mapperArea.height(),
                'class': mapperArea.attr('class'),
                'css': 'border:2px solid black'
            }).insertBefore(mapperArea);
                
            mapperArea.css('visibility', 'hidden');
            var offset = mapperDiv.offset();
            mapperArea.attr('rows', 1);
            
            var mapperEditor = ace.edit(mapperDiv[0]);
            mapperEditor.renderer.setShowGutter(false);
            mapperEditor.getSession().setValue(mapperArea.val());
            mapperEditor.getSession().setMode("ace/mode/python");
            mapperEditor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
            mapperEditor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
            //editor.setKeyboardHandler("ace/keyboard/vim");
            //editor.setTheme("ace/theme/idle_fingers");
            //editor.setTheme("ace/theme/twilight");
            mapperEditor.setTheme("ace/theme/iplastic");
//             editor.setOptions({       
//                 fontSize: "12pt"
//               });

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa('mainulhossain@gmail.com' + ":" + 'mainul'));
                    },
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }
            
            self.addSample = function(task) {
                $('#addSample').modal('hide');
                
                var formdata = new FormData();
                formdata.append('sample', mapperEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
                
                if (self.name() === undefined)
                	return;
                formdata.append('name', self.name());
                
                if (self.desc() !== undefined)
                	formdata.append('desc', self.desc());

                self.ajax(self.samplesURI, 'POST', formdata).done(function(data) {
                	
                });
            }
            
            self.getCodeEditor = function() { return mapperEditor; }
        }
        
        function AddLibraryViewModel() {
            var self = this;
            self.tasksURI = 'todo/api/v1.0/tasks';
            
            self.name = ko.observable();
            self.org = ko.observable();
 
            // configure ace.js for code editor
            var mapperArea = $("#mapper");
            
            var mapperDiv = $('<div>', {
                position: 'absolute',
                id: 'aceeditor',
                width: mapperArea.width(),
                height: 200,//mapperArea.height(),
                'class': mapperArea.attr('class'),
                'css': 'border:2px solid black'
            }).insertBefore(mapperArea);
                
            mapperArea.css('visibility', 'hidden');
            var offset = mapperDiv.offset();
            mapperArea.attr('rows', 1);
            
            var mapperEditor = ace.edit(mapperDiv[0]);
            mapperEditor.renderer.setShowGutter(false);
            mapperEditor.getSession().setValue(mapperArea.val());
            mapperEditor.getSession().setMode("ace/mode/json");
            mapperEditor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
            mapperEditor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
            //editor.setKeyboardHandler("ace/keyboard/vim");
            //editor.setTheme("ace/theme/idle_fingers");
            //editor.setTheme("ace/theme/twilight");
            mapperEditor.setTheme("ace/theme/iplastic");
//             editor.setOptions({       
//                 fontSize: "12pt"
//               });

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa('mainulhossain@gmail.com' + ":" + 'mainul'));
                    },
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }
            
            self.addLibrary = function(task) {
            	$('#add').modal('hide');
            	
            	var files = $("#module").get(0).files;
            	var formdata = new FormData();
            	formdata.append('library', files[0]); //use get('files')[0]
            	formdata.append('mapper', mapperEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
            	
            	if (self.name() !== undefined)
            		formdata.append('package', self.name());
            	if (self.org() !== undefined)
            		   formdata.append('org', self.org());

                self.ajax(self.tasksURI, 'POST', formdata).done(function(data) {
                                   	
                    text = '';
                    $.each(data.out, function(i, t) {
                        text += t + '\n';
                    });
                    $("#output").val(text);
                    
                    text = '';
                    $.each(data.err, function(i, t) {
                        text += t + '\n';
                    });
                    
                    $("#error").val(text);
                });
            }
            
            self.getCodeEditor = function() { return mapperEditor; }
        }
        function EditTaskViewModel() {
            var self = this;
            self.package_name = ko.observable();
            self.name = ko.observable();
            self.internal = ko.observable();
            self.example = ko.observable();
 
            self.setTask = function(task) {
                self.task = task;
                self.package_name(task.package_name());
                self.name(task.name());
                self.internal(task.internal());
                self.example(task.example());
                $('edit').modal('show');
            }
 
            self.editTask = function() {
                $('#edit').modal('hide');
                tasksViewModel.edit(self.task, {
                	package_name: self.package_name(),
                	name: self.name(),
                    internal: self.internal(),
                    example: self.example()
                });
            }
        }
        function LoginViewModel() {
            var self = this;
            self.username = ko.observable();
            self.password = ko.observable();
            tasksViewModel.login('mainulhossain@gmail.com', 'mainul');
            tasksViewModel.loadSamples('mainulhossain@gmail.com', 'mainul')
            
            self.login = function() {
                $('#login').modal('hide');
                tasksViewModel.login(self.username(), self.password());
            }
        }
        
        var tasksViewModel = new TasksViewModel();
        var addLibraryViewModel = new AddLibraryViewModel();
        var sampleViewModel = new SampleViewModel();
        var editTaskViewModel = new EditTaskViewModel();
        var loginViewModel = new LoginViewModel();
//        var samplesViewModel = new SamplesViewModel();
//        samplesViewModel.loadSamples('mainulhossain@gmail.com', 'mainul')
        ko.applyBindings(tasksViewModel, $('#main')[0]);
        ko.applyBindings(addLibraryViewModel, $('#add')[0]);
        ko.applyBindings(sampleViewModel, $('#addSample')[0]);
        ko.applyBindings(editTaskViewModel, $('#edit')[0]);
        ko.applyBindings(loginViewModel, $('#login')[0]);
        
//        ko.applyBindings(samplesViewModel, $('#samples')[0]);
    </script>
</body>
</html>
